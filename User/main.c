#include "stm32f10x.h"                  // Device header
#include "OLED.h"
#include <math.h>

#include "Camera_API.h"

#include "CeruleanBird.h"

#include "TextureMapper_API.h"

#include "bit_operate.h"

#include "WorldMap_API.h"

#include "Camera_internal.h"


volatile uint32_t frame_count = 0;
volatile uint32_t fps = 0;

void TIM2_IRQHandler(void) {
    if (TIM_GetITStatus(TIM2, TIM_IT_Update) != RESET) {
        TIM_ClearITPendingBit(TIM2, TIM_IT_Update);
        fps = frame_count;
        frame_count = 0;
    }
}

void init_timer(void) {
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);

    TIM_TimeBaseInitTypeDef timerInitStructure;
    timerInitStructure.TIM_Prescaler = 7200 - 1;  // 10 kHz
    timerInitStructure.TIM_CounterMode = TIM_CounterMode_Up;
    timerInitStructure.TIM_Period = 10000 - 1;  // 1 second
    timerInitStructure.TIM_ClockDivision = TIM_CKD_DIV1;
    TIM_TimeBaseInit(TIM2, &timerInitStructure);
    TIM_ITConfig(TIM2, TIM_IT_Update, ENABLE);
    TIM_Cmd(TIM2, ENABLE);

    NVIC_InitTypeDef nvicStructure;
    nvicStructure.NVIC_IRQChannel = TIM2_IRQn;
    nvicStructure.NVIC_IRQChannelPreemptionPriority = 0;
    nvicStructure.NVIC_IRQChannelSubPriority = 1;
    nvicStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&nvicStructure);
}

void frame_capture(void) {
    frame_count++;
}

//测试地图
unsigned char TestMap2[] =
{
  1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,2,2,2,2,2,0,0,0,0,3,0,3,0,3,0,0,0,1,
  1,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,2,0,0,0,2,0,0,0,0,3,0,0,0,3,0,0,0,1,
  1,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,2,2,0,2,2,0,0,0,0,3,0,3,0,3,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,4,0,4,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,4,0,0,0,0,5,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,4,0,4,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,4,0,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
  1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
};

unsigned char kun2[]={
	
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0x3F,0x1F,0x0F,0x07,0x03,0x03,0x01,0x03,0x83,0x83,0x81,0x01,0x03,0x07,0x07,0x07,
0x0F,0x17,0x2F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x01,0x02,
0x00,0x00,0x00,0x00,0x00,0x00,0x8C,0xFF,0xFF,0xEF,0xEF,0x27,0xA4,0xA0,0x80,0x80,
0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,
0x6B,0xFB,0xF5,0xE3,0xFB,0xFC,0xFF,0x20,0x8F,0xFF,0xFF,0xFF,0xFF,0xFE,0xFC,0xF0,
0xFC,0xFE,0xFF,0xFF,0xFF,0x7F,0x6F,0x27,0xA7,0xA7,0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x7C,0xF0,0xE8,0xEC,0xF8,0xF8,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0x06,0x0E,0x0F,0x2F,0x07,0x07,0x07,0x0E,0x0F,0x19,0x03,0x03,0x01,0x01,0x01,0x01,
0x01,0x03,0x03,0x0F,0x1F,0x3E,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x1F,0x1F,0x0F,0x0F,
0x47,0x77,0x3F,0x1E,0x00,0x06,0x02,0x7F,0x9F,0xEF,0xEF,0x73,0xBB,0xD9,0xEE,0xF2,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x0C,0x5E,0xBE,0xBC,0xB8,0xDC,0xDC,0xDE,0xDF,0xFF,0xFD,0xFE,0x1A,0xB1,0xFF,0xFF,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x08,0x00,
0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x03,0x03,0x02,0x00,0x00,0x00,0x07,0x03,0x03
	
};





int main(){

	OLED_Init();
	SystemInit();
    init_timer();
	
	Camera_InitTypeDef camera_sturct;
	camera_sturct.direction.x = -1;
	camera_sturct.direction.y = 0;
	camera_sturct.FOV = 66;
	camera_sturct.moveSpeed = 0.01;
	camera_sturct.rotSpeed = 0.01 * 3.0;
	camera_sturct.position.x = 10;
	camera_sturct.position.y = 12;
	
	Camera_Struct* camera;
	
	//画布重定向
	Canvas_SetCanvasModeToRedirect(GetBufferAPI());
	
	//初始化
	CeruleanBird_Init(&camera, &camera_sturct);
	
	//添加纹理
	Texture_Add(1,kun2,48,48,BIT_TEXTURE);
	Texture_Add(2,kun2,48,48,BIT_TEXTURE);
	Texture_Add(3,kun2,48,48,BIT_TEXTURE);
	Texture_Add(4,kun2,48,48,BIT_TEXTURE);
	//添加地图
	WorldMap_Add(1,TestMap2,24,24);

		
	while(1){

		
	
		
		//地面打印
		for(int i = 32;i<64;i++){
			for(int j = 0;j<128;j++){
				//双数列
				if(j%2 == 0){
					if(i%2 == 0){//双数行打印
						Pixel_Operate(i,j,OPEN);
					}
				}
				
				//单数列
				else{
					if(i%2 != 0){//单数行打印
						Pixel_Operate(i,j,OPEN);
					}
					
				}

			}
		}
	
		
		Camera_Render(camera);		
		frame_capture();
		Hj_String(0,0,"FPS:");
		Hj_Int(16,0,fps);
		print();
		Camera_LeftPan(camera);
		Buffer_Refresh();
	
	
	}
}

